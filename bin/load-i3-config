#!/bin/bash

dotfiles_dir=$1
[[ ! $dotfiles_dir ]] && dotfiles_dir=$X_DOTFILES

template_file=$dotfiles_dir/i3/config
config_file=~/.config/i3/config
config_contents=$(cat $template_file)


# Edit the template on the fly to load some optional packages
# ===========================================================
if [[ $(type -p twmnd) ]]; then
  config_contents=$(
  echo "$config_contents" |\
    # load twmnd before udiskie
    sed -E 's/^((exec.+)udiskie.+$)/\2twmnd\n\1/' |\
    # enable notifications
    sed -E '/^exec.+udiskie.+$/ s/N//'
  )

  # Enable the twmn configuration included in the repo.
  # NOTE: If there already is a configuration file, it'll be overwritten.
  twmn_config_dst=$XDG_CONFIG_HOME/twmn
  twmn_config_src=$dotfiles_dir/twmn
  if [[ ! -L $twmn_config_dst || $(readlink $twmn_config_dst) != $twmn_config_src ]]; then
    rm -rf $twmn_config_dst
    ln -s $twmn_config_src $twmn_config_dst
  fi
fi

if [[ $(type -p compton) ]]; then
  config_contents=$(
  echo "$config_contents" |\
    sed -E '0,/^exec --no-startup-id/s#^((exec .+ ).+$)#\2compton -b --config $X_DOTFILES/compton/compton.conf\n\1#'
  )
fi


# Parse the template, write the result to the config file and load it.
# ====================================================================
config_contents=$(
echo "$config_contents" |\
  # remove comments
  sed '/^\s*#/d' |\

  # remove empty lines
  sed '/^\s*$/d' |\

  # replace $X_DOTFILES with its value
  sed "s/\$X_DOTFILES/$(echo $dotfiles_dir | sed 's#/#\\/#g')/g"
)

# write the configuration file with a little warning header at the top of it
cat <<EOF > $config_file
#
#==============================================================================
#
# DO NOT EDIT THIS FILE.
#
#==============================================================================
#
# New settings must be set in "$template_file" and loaded with
# \`$X_DOTFILES/bin/load-i3-config\` or using the keyboard shortcut \`\$mod+Shift+r\`.
#
$config_contents
EOF

i3-msg 'restart'
