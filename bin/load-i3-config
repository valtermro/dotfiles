#!/bin/bash

dotfiles_dir=$1
[[ ! $dotfiles_dir ]] && dotfiles_dir=$X_DOTFILES

template_file=$dotfiles_dir/i3/config
config_file=~/.config/i3/config

cat <<HEADER > $config_file
#
#==============================================================================
#
# DO NOT EDIT THIS FILE.
#
#==============================================================================
#
# New settings must be set in "$template_file" and loaded with
# \`$X_DOTFILES/bin/load-i3-config\` or using the keyboard shortcut \`\$mod+Shift+r\`.
#
HEADER

# parse the template
parsed_config=$(
cat $template_file |\
  # remove comments
  sed '/^\s*#/d' |\

  # remove empty lines
  sed '/^\s*$/d' |\

  # replace $X_DOTFILES with its value
  sed "s/\$X_DOTFILES/$(echo $dotfiles_dir | sed 's#/#\\/#g')/g"
)


if [[ $(type -p twmnd) ]]; then
  parsed_config=$(
  echo "$parsed_config" |\
    # load twmnd before udiskie
    sed -r 's/^((exec.+)udiskie.+$)/\2twmnd\n\1/' |\
    # enable notifications
    sed -r '/^exec.+udiskie.+$/ s/N//'
  )

  # Enable the twmn configuration included in the repo.
  # NOTE: If there already is a configuration file, it'll be overwritten.
  twmn_config_dst=$XDG_CONFIG_HOME/twmn
  twmn_config_src=$dotfiles_dir/twmn
  if [[ ! -L $twmn_config_dst || $(readlink $twmn_config_dst) != $twmn_config_src ]]; then
    rm -rf $twmn_config_dst
    ln -s $twmn_config_src $twmn_config_dst
  fi
fi

echo "$parsed_config" > $config_file
i3-msg 'restart'
